import java.io.IOException;
import java.net.ServerSocket;
import java.net.Socket;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.io.DataInputStream;
import java.io.DataOutputStream;
import java.sql.*;

public class Main {
    public static void main(String[] args) {
        new MyServer();
    }
}



class MyServer {
    ArrayList<ClientHandler> client;
    ArrayList<String> clientnick;
    ServerSocket server = null;

    //конструктор для создание сервера
    public MyServer() {

        SQLHandler.connect();
        Socket s;
        //создаем список клиентов
        client = new ArrayList<>();
        //создаем список ников клиентов для обновления списка активных пользователей чата
        clientnick = new ArrayList<>();
        try {
            //определяем сокет для соединения клинта и сервера
            server = new ServerSocket(8189);
            while (true){

                System.out.println("Waiting for client.......");
                s = server.accept();
                System.out.println("Client connected");
                ClientHandler clientHandler = new ClientHandler(s,this);

                new Thread(clientHandler).start();
            }
        } catch (IOException e) {
            e.printStackTrace();
        }finally {
            try {
                server.close();
                SQLHandler.disconnect();
            }catch (IOException e){
                e.printStackTrace();
            }

        }
    }
    //метод возвращает клиента
    public synchronized ArrayList<ClientHandler> getClient() {
        return client;
    }

    //метод для отправки сообщения определенному участнику чата
    public synchronized void sendPersonalMessage(String nick, String message){
        for(ClientHandler ch : client){
            if(ch.getName().equals(nick)){
                ch.sendMsg(message);
                break;
            }
        }
    }

    //метод определяющий занят ли никнейм
    public synchronized boolean isNickBusy(String nick){
        for (ClientHandler clientHandler: client) {
             if (clientHandler.getName().equals(nick)){
                 return true;
             }
        }
        return false;
    }

    //метод для добавления пользователя в список клиентов, а также обновление списка активных пользователей
    public synchronized void addClient(ClientHandler clientHandler){
        client.add(clientHandler);
        broadCastMsg(clientHandler.getName() + " вошел в чат");
        ArrayList<String> listuserArr = getClientnick();
        String listUser = "";
        for (String x: listuserArr) {
            listUser = listUser + " " + x;
        }
        for (ClientHandler c : client) {
            c.sendMsg("/listuser" + listUser);
        }
    }

    //метод для добавления нового никнейма при регистрации в общий список никнеймов
    public synchronized void addClientnick(String nick){
        clientnick.add(nick);

    }

    //метод для отправки сообщений всем участникам чата с указанием времени
    public synchronized void broadCastMsg(String msg){
        String str = new SimpleDateFormat("HH:mm:ss").format(Calendar.getInstance().getTime());
        msg =  str + " " + msg;

        for (ClientHandler c : client) {
            c.sendMsg(msg);
        }
    }

    //метод для удаления пользователя из списка клиентов, а также обновление списка активных пользователей
    public synchronized void removeClient(ClientHandler clientHandler){
        client.remove(clientHandler);
        broadCastMsg(clientHandler.getName() + " вышел из чата");
        ArrayList<String> listuserArr = getClientnick();
        String listUser = "";
        for (String x: listuserArr) {
            listUser = listUser + " " + x;
        }
        for (ClientHandler c : client) {
            c.sendMsg("/listuser" + listUser);
        }

    }

    //метод для удаления никнейма из общего списка никнеймов
    public synchronized void removeClientuser(String user){
        int numberuser = clientnick.indexOf(user);
        clientnick.remove(numberuser);
    }

    //метод для получения списка никнеймов
    public synchronized ArrayList<String> getClientnick() {
        return clientnick;
    }

    //метод переименовывает никнейм, обновляется общий список никнеймов, а также обновление списка активных пользователей
    public synchronized void renameClientuser(String nick, String oldnick){
        int numberuser = clientnick.indexOf(oldnick);
        clientnick.remove(numberuser);
        clientnick.add(nick);

        ArrayList<String> listuserArr = getClientnick();
        String listUser = "";
        for (String x: listuserArr) {
            listUser = listUser + " " + x;
        }
        for (ClientHandler c : client) {
            c.sendMsg("/listuserchang" + listUser);
        }
    }
}



class ClientHandler implements Runnable {
    private Socket s;
    private DataInputStream in;
    private DataOutputStream out;
    private static int CLIENT_COUNTER = 0;
    private String name;
    private MyServer owner;

    //конструктор для общения сервера и клиента
    public ClientHandler(Socket s, MyServer owner) {
        this.s = s;
        name = "";
        this.owner = owner;
        try {
            //входящий поток сообщений
            in = new DataInputStream(s.getInputStream());
            //изходящий поток сообщений
            out = new DataOutputStream(s.getOutputStream());
        } catch (IOException e) {
            e.printStackTrace();
        }

    }

    //метод для получения никнейма
    public String getName() {
        return name;
    }

    //установка никнейма
    public void setName(String name) {
        this.name = name;
    }


    //метод для запуска потока
    @Override
    public void run() {
        try {
            while (true) {

                String str = null;
                //получение входящего сообщения от клиента
                str = in.readUTF();

                //поключение к серверу
                if (str != null && name.isEmpty()) {
                    String[] arr = str.split("\\s");
                    if (arr.length == 3) {
                        //получение никнейма для пользователя
                        if (arr[0].equals("/auth")) {
                            String login = arr[1];
                            String pass = arr[2];
                            String nick = SQLHandler.getNickByLoginAndPassword(login, pass);
                            if (nick != null) {
                                synchronized (owner.getClient()) {
                                    //если никнейм не занят, то пользователь авторизируется,клиент и никнейм добавляется в общий список клиентов и никнеймов,
                                    if (!owner.isNickBusy(nick)) {
                                        name = nick;
                                        sendMsg("/yes " + getName());
                                        owner.addClientnick(nick);
                                        owner.addClient(this);
                                        //для обновление активного списка клиентов на панели чата
                                        ArrayList<String> listuserArr = owner.getClientnick();
                                        String listUser = "";
                                        for (String x: listuserArr) {
                                            listUser = listUser + " " + x;
                                        }

                                        sendMsg("/listuser" + listUser);
                                        continue;
                                    } else {
                                        //отправляется сообщение клиенту что пользователь уже авторизирован
                                        sendMsg("NickBusy");
                                    }
                                }
                            } else if (nick == null) {
                                //если никнейм не найден, то отправляется сообщение "Неправильно введен логин или пароль"
                                sendMsg("stop");
                            }

                        }
                    } else if (arr.length == 4) {
                        //регистрация нового пользователя в чате
                        if (arr[0].equals("/reg")) {
                            String newlogin = arr[1];
                            String newpass = arr[2];
                            String newnick = arr[3];
                            //проверка на существование логина в БД
                            if (SQLHandler.isWrongLogin(newlogin)) {
                                sendMsg("StopUser");
                            //проверка на существование никнейма в БД
                            } else if (SQLHandler.isWrongNick(newnick)) {
                                sendMsg("StopNick");
                            //регистрация нового пользователя, если нет повторяющихся логина и никнейма
                            } else if (!SQLHandler.isWrongLogin(newlogin) & !SQLHandler.isWrongNick(newnick)) {
                                SQLHandler.addEntry(newlogin, newpass, newnick);
                            }
                        }
                    }
                }
                //отправка сообщений
                if (str != null) {
                    //отправка служебных сообщений
                    if (str.startsWith("/")) {
                        //выход из клиента в окно авторизации
                        if (str.equals("/end")) break;
                        //отправить сообщение определенному пользователю чата
                        if (str.startsWith("/pm")) {
                            String[] w = str.split("\\s");
                            String nick = w[1];
                            String msg = str.substring(w[0].length() + w[1].length() + 2);
                            if (!getName().equals(nick)) {
                                owner.sendPersonalMessage(nick, "Сообщение от " + getName() + ": " + msg);
                                sendMsg(getName() + " отправил " + nick + " : " + msg);
                            }
                        }
                        //поменять никнейм пользователю
                        if (str.startsWith("/changenick")) {
                            String[] w = str.split("\\s");
                            String nick = w[1];
                            String oldnick = getName();
                            owner.renameClientuser(nick,oldnick);
                            SQLHandler.changeNick(nick, oldnick);
                            setName(nick);
                            owner.broadCastMsg(oldnick + " поменял на " + nick);
                        }
                        continue;
                    }
                    System.out.println(name + " says: " + str);
                    owner.broadCastMsg(name + " " + str);

                }

                try {
                    Thread.sleep(100);
                } catch (InterruptedException e) {
                    e.printStackTrace();
                }
            }

        } catch (IOException e) {
            e.printStackTrace();
        } finally {
            //при отключении клиента удаляются из клиенты из списка клиентов и никнеймов из списка никнеймов
            owner.removeClientuser(getName());
            owner.removeClient(this);
            //обновление активного списка пользователей в окне чата
            ArrayList<String> listuserArr = owner.getClientnick();
            String listUser = "";
            for (String x: listuserArr) {
                listUser = listUser + " " + x;
            }
            sendMsg("/listuserrem" + listUser);
            try {
                s.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }

    //метод для отправки сообщений клиенту
    public void sendMsg(String msg) {

        try {
            out.writeUTF(msg);
            out.flush();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}



class SQLHandler {
    private static Connection cn;
    private static PreparedStatement pr;
    public static void connect(){
        try {
            //подключение к базе данных
            Class.forName("org.sqlite.JDBC");
            cn = DriverManager.getConnection("jdbc:sqlite:forChat.db");
            System.out.println("База подключена!");
        } catch (Exception e) {
            e.printStackTrace();
        }

    }
    //метод отключения от базы данных
    public static void disconnect(){
        try {
        if (cn!=null && !cn.isClosed())
            cn.close();
            System.out.println("База отключена");
        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    //метод проверяющий логин и пароль при подключении к серверу
    public static String getNickByLoginAndPassword(String login, String password){
        ResultSet rs;
        String str = null;

        try {
            pr = cn.prepareStatement("SELECT nickname FROM Main WHERE login = ? AND password = ?");
            pr.setString(1, login);
            pr.setString(2, password);
            rs = pr.executeQuery();
            while (rs.next()){
                str = rs.getString(1);
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }
        return str;
    }

    //метод меняющий в БД никнейм
    public static void changeNick(String newNick, String oldNick){
        try {
            pr = cn.prepareStatement("UPDATE Main SET nickname = ? WHERE nickname = ?;");
            pr.setString(1,newNick);
            pr.setString(2, oldNick);
            pr.executeUpdate();
        } catch (SQLException e) {
            e.printStackTrace();
        }

    }

    //метод регистрирующий нового пользователя, добавление в БД
    public static void addEntry(String login, String pass, String nick){
        try {
            pr = cn.prepareStatement("INSERT INTO Main(login, password,nickname) VALUES (?,?,?);");
            pr.setString(1, login);
            pr.setString(2, pass);
            pr.setString(3,nick);
            pr.execute();
        } catch (SQLException e) {
            e.printStackTrace();
        }

    }

    // метод проверяющий логин
    public static boolean isWrongLogin(String login) {
        ResultSet rs;
        String str = null;
        try {
            pr = cn.prepareStatement("SELECT * FROM Main WHERE login = ?");
            pr.setString(1, login);
            rs = pr.executeQuery();
            while (rs.next()) {
                str = rs.getString(1);
                if(str == null){
                    return false;
                }
                return !str.equals(login);
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }

    // метод проверяющий никнейм
    public static boolean isWrongNick(String nick) {
        ResultSet rs;
        String str = null;
        try {
            pr = cn.prepareStatement("SELECT * FROM Main WHERE nickname = ?");
            pr.setString(1, nick);
            rs = pr.executeQuery();
            while (rs.next()) {
                str = rs.getString(1);
                if(str == null){
                    return false;
                }
                return !str.equals(nick);
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }
        return false;
    }
}

